-- 查询所有符合条件的数据
SELECT TRAN_TYPE, COUNT(1)
FROM (SELECT aa.TRAN_TYPE
      FROM TRADE aa
               JOIN trade@DB_REMOTE_LINK bb ON aa.BATCH_NO = bb.BATCH_NO
      WHERE aa.TRAN_STATUS <> '10JiaoYiWanCheng'
        AND bb.TRAN_STATUS = '10JiaoYiWanCheng'
      UNION ALL
      SELECT aa.TRAN_TYPE
      FROM TRADE@DB_REMOTE_LINK aa
      WHERE aa.TRAN_STATUS = '10JiaoYiWanCheng'
        AND NOT EXISTS (SELECT 1 FROM TRADE WHERE BATCH_NO = aa.BATCH_NO)) mm
GROUP BY TRAN_TYPE;

SELECT *
FROM TRADE
WHERE TRAN_TYPE = 3110
  AND REG_DATE > 20250431;

-- 前置插入数据
INSERT INTO HMFMSFD.FSS_DATA_PERMISSION (DP_ID, USER_ID, REAL_NMBR, DESCRIPTION, ISDEL, CREATE_BY, UPDATE_BY,
                                         CREATE_TIME, UPDATE_TIME, MNG_ORG_ID)
VALUES (1, 1, '158001201110000869', '1', 0, ' ', ' ', NULL, NULL, 100);

-- 插入业务数据 250916001028
INSERT INTO HMFMSFD.TRADE (BATCH_NO, TRAN_TYPE, TRAN_STATUS, REG_OPERID, REG_OPERNAME, REG_DATE, REG_TIME, FINISH_DATE,
                           FINISH_TIME, SYS_TIME, SYS_DATE, TRAN_AMT, TRAN_AREA, TRAN_COUNT, SECT_ID, SECT_NAME,
                           CRT_ORG_ID, DIST_ID, ID, REQ_NOTIFY_NO, RES_NOTIFY_NO, TRAN_MODE, TRAN_GROUP,
                           ORIGIN_BATCH_NO, TRADE_SRC, OTR_REMARK, IS_SUBTRACT)
VALUES ('250916001028', '3110', '10JiaoYiWanCheng', '131', '高雅君', '20250916', '161514', '20250923', '192057',
        '143500', '20250924', 1934.00, 48.37, 1, 120002168348, '南岸家园', 100, 111, NULL, '250916001028521000',
        '250916001028521000', '1', '250916001028', NULL, NULL, '20250924补做;', NULL);
INSERT INTO HMFMSFD.TRADE_BANK (BATCH_NO, DES_BRANCH_CODE, DES_BRANCH_NAME, DES_SYS_CODE, DES_REAL_NMBR,
                                SRC_BRANCH_CODE, SRC_BRANCH_NAME, SRC_SYS_CODE, SRC_REAL_NMBR, CORE_REAL_NMBR,
                                CP_ACCT_NAME, CP_ACCT_NUM, DES_BIG_AMOUNT_CODE, DES_SMALL_AMOUNT_CODE)
VALUES ('250916001028', '020945802', '天津银行第一中心支行', '01', '158001201110000869', NULL, NULL, NULL, NULL, NULL,
        NULL, NULL, NULL, NULL);
INSERT INTO HMFMSFD.PAY_DETAIL (BATCH_NO, FUND, INFO_ID, INFO_AREA, DEV_SHOULD, OWN_SHOULD, DEV_AMT, OWN_AMT,
                                PRE_TRAN_AMT, TRAN_FLAG, TRAN_AMT, DEV_BILL, OWN_BILL, RECV_CODE, DEC_REMARK,
                                DEPOSITOR_NAME, INVOICE_REMARK, CON_TYPE_REMARK, GEN_TYPE_REMARK)
VALUES ('250916001028', 120002188546, 120002188546, 48.37, 0.00, 1934.00, 0.00, 1934.00, 1934.00, '2', 1934.00, NULL,
        NULL, NULL, NULL, NULL, NULL, NULL, NULL);
INSERT INTO HMFMSFD.PAY_SUM (BATCH_NO, PAY_TYPE, FULL_PERCENT, PAY_SCOPE, PAY_DATE, SUM_REMARK, IS_AUTOMATIC)
VALUES ('250916001028', '99', 0.00, '南岸家园14号楼', '20250923', NULL, '1');

-- 恢复业务数据状态 250916001028
UPDATE TRADE
SET TRAN_STATUS  = '09ZaiTuJiaoYi',
    FINISH_TIME  = NULL,
    FINISH_DATE  = NULL,
    SYS_DATE     = NULL,
    SYS_TIME     = NULL,
    MNG_ORG_ID   = 100,
    MNG_ORG_NAME = '天津市住房保障服务中心'
WHERE BATCH_NO = '250916001028';
-- 插入操作表数据 250916001028
INSERT INTO HMFMSFD.BASE_INFO_OPER (BATCH_NO, SEQ_NO, DATA_TYPE, INFO_ID, INFO_CODE, INFO_TYPE, ONWAY_BIT, INFO_STATUS,
                                    INFO_NAME, INFO_ADDR, OWN_COUNT, INFO_AREA, FUND, FUND_TYPE, REAL_NMBR, INFO_REMARK,
                                    RONG1, RONG2, RONG3, SYNC_FLAG)
VALUES ('250916001028', 1, '1', 120002188546, '111612301014002005020', '60', 0, '0', '孟繁强', '西青区南岸家园14-2-502',
        1, 48.37, 0, NULL, '158001201110000869', '数据迁移', NULL, NULL, NULL, NULL);
INSERT INTO HMFMSFD.BASE_INFO_OPER (BATCH_NO, SEQ_NO, DATA_TYPE, INFO_ID, INFO_CODE, INFO_TYPE, ONWAY_BIT, INFO_STATUS,
                                    INFO_NAME, INFO_ADDR, OWN_COUNT, INFO_AREA, FUND, FUND_TYPE, REAL_NMBR, INFO_REMARK,
                                    RONG1, RONG2, RONG3, SYNC_FLAG)
VALUES ('250916001028', 2, '2', 120002188546, '111612301014002005020', '60', 0, '0', '李耀香', '西青区南岸家园14-2-502',
        1, 48.37, 0, NULL, '158001201110000869', '数据迁移', NULL, NULL, NULL, NULL);
INSERT INTO HMFMSFD.BASE_INFO_OPER (BATCH_NO, SEQ_NO, DATA_TYPE, INFO_ID, INFO_CODE, INFO_TYPE, ONWAY_BIT, INFO_STATUS,
                                    INFO_NAME, INFO_ADDR, OWN_COUNT, INFO_AREA, FUND, FUND_TYPE, REAL_NMBR, INFO_REMARK,
                                    RONG1, RONG2, RONG3, SYNC_FLAG)
VALUES ('250916001028', 3, '5', 120002168348, '111612301', '30', 0, '0', '南岸家园', '天津市西青区西营门街南岸家园',
        1357, 81803.68, 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL);
INSERT INTO HMFMSFD.HOU_INFO_OPER (BATCH_NO, SEQ_NO, DATA_TYPE, PRESALE_CODE, INFO_ID, HOUSE_ID, EXIST_FLAG,
                                   HAS_BASEMENT, BUILD_TYPE, HOU_KIND, HOU_TYPE, HOU_PRTY_KIND, HOU_PAY_TYPE,
                                   STRUCT_TYPE, HOU_SOURCE, DEV_ID, DEV_NAME, SALE_DATE, SALE_FLAG, BUY_PACT_NO,
                                   BUY_MONEY, CERT_CODE, CERT_TYPE, POST_ADDR, POSTCODE, CHECK_DATE, OWN_TEL,
                                   DEV_CHECK_BASE, OWN_CHECK_BASE, CHECK_RATE, FLOOR_INDEX, FLOOR_COUNT, DEV_SHOULD,
                                   DEV_EXPRESS, DEV_EXPRESS_CN, OWN_SHOULD, OWN_EXPRESS, OWN_EXPRESS_CN, DEV_PAY_FLAG,
                                   DEV_DATE, OWN_PAY_FLAG, OWN_DATE, ORGN_ADDR, RECV_CODE, DEV_BILL_CODE, OWN_BILL_CODE,
                                   NEED_PAY, OPER_BAL, ADMIN_DIST_TYPE, HOU_REMARK, RONG1, RONG2, RONG3, HOU_ROPER_CERT,
                                   IS_CERT, REALMS_ID, IS_EBILL, DEV_EBILL_CODE, OWN_EBILL_CODE, HOUINFO_NO, DEV_CODE,
                                   SALE_LICENSE, MERGE_FLAG)
VALUES ('250916001028', 1, '1', NULL, 120002188546, '111612301014002005020', '0', NULL, NULL, '01', '01', '1 ', '5',
        NULL, '1', 103417, '天津市西青区环城安居建设有限公司', NULL, '1', NULL, 0.00, '120111196201063032', '01', NULL,
        NULL, NULL, NULL, 1.00, 1.00, NULL, NULL, NULL, 0.00, NULL, NULL, 0.00, NULL, NULL, NULL, NULL, NULL, NULL,
        '罗浮路与泰宁道交口东南侧南岸家园14-2-502', 'CQ000000066904', '00496207-2014', NULL, NULL, 2315.15, NULL,
        '数据迁移.原交存类型:1', NULL, NULL, NULL, NULL, NULL, NULL, '0', NULL, NULL,
        '8E3D4319-DED7-4385-B7E0-4A32BD124D2B', NULL, NULL, NULL);
INSERT INTO HMFMSFD.HOU_INFO_OPER (BATCH_NO, SEQ_NO, DATA_TYPE, PRESALE_CODE, INFO_ID, HOUSE_ID, EXIST_FLAG,
                                   HAS_BASEMENT, BUILD_TYPE, HOU_KIND, HOU_TYPE, HOU_PRTY_KIND, HOU_PAY_TYPE,
                                   STRUCT_TYPE, HOU_SOURCE, DEV_ID, DEV_NAME, SALE_DATE, SALE_FLAG, BUY_PACT_NO,
                                   BUY_MONEY, CERT_CODE, CERT_TYPE, POST_ADDR, POSTCODE, CHECK_DATE, OWN_TEL,
                                   DEV_CHECK_BASE, OWN_CHECK_BASE, CHECK_RATE, FLOOR_INDEX, FLOOR_COUNT, DEV_SHOULD,
                                   DEV_EXPRESS, DEV_EXPRESS_CN, OWN_SHOULD, OWN_EXPRESS, OWN_EXPRESS_CN, DEV_PAY_FLAG,
                                   DEV_DATE, OWN_PAY_FLAG, OWN_DATE, ORGN_ADDR, RECV_CODE, DEV_BILL_CODE, OWN_BILL_CODE,
                                   NEED_PAY, OPER_BAL, ADMIN_DIST_TYPE, HOU_REMARK, RONG1, RONG2, RONG3, HOU_ROPER_CERT,
                                   IS_CERT, REALMS_ID, IS_EBILL, DEV_EBILL_CODE, OWN_EBILL_CODE, HOUINFO_NO, DEV_CODE,
                                   SALE_LICENSE, MERGE_FLAG)
VALUES ('250916001028', 2, '2', NULL, 120002188546, '111612301014002005020', '0', NULL, NULL, '01', '01', '1 ', '5',
        NULL, '1', 103417, '天津市西青区环城安居建设有限公司', NULL, '1', NULL, 0.00, '120223197210171225', '01', NULL,
        NULL, NULL, NULL, 1.00, 1.00, NULL, NULL, NULL, 0.00, NULL, NULL, 0.00, NULL, NULL, NULL, NULL, NULL, NULL,
        '罗浮路与泰宁道交口东南侧南岸家园14-2-502', 'CQ000000066904', '00496207-2014', NULL, NULL, 2315.15, NULL,
        '数据迁移.原交存类型:1', NULL, NULL, NULL, NULL, NULL, NULL, '0', NULL, NULL,
        '8E3D4319-DED7-4385-B7E0-4A32BD124D2B', NULL, NULL, NULL);
INSERT INTO HMFMSFD.HOU_UNITS_OPER (BATCH_NO, SEQ_NO, DATA_TYPE, INFO_ID, UNIT_ID, ROOM_CODE, CN_ROOM_CODE, UNIT_CODE,
                                    CN_UNIT_CODE, BUILD_CODE, CN_BUILD_CODE, ROAD_CODE, CN_ROAD_CODE, CLUSTER_CODE,
                                    CN_CLUSTER_CODE, FLOOR_CODE, CN_FLOOR_CODE)
VALUES ('250916001028', 1, '1', 120002188546, '111612301014002', '00502', '502', '002', '2', '014', '14', NULL, NULL,
        NULL, NULL, NULL, NULL);
INSERT INTO HMFMSFD.HOU_UNITS_OPER (BATCH_NO, SEQ_NO, DATA_TYPE, INFO_ID, UNIT_ID, ROOM_CODE, CN_ROOM_CODE, UNIT_CODE,
                                    CN_UNIT_CODE, BUILD_CODE, CN_BUILD_CODE, ROAD_CODE, CN_ROAD_CODE, CLUSTER_CODE,
                                    CN_CLUSTER_CODE, FLOOR_CODE, CN_FLOOR_CODE)
VALUES ('250916001028', 2, '2', 120002188546, '111612301014002', '00502', '502', '002', '2', '014', '14', NULL, NULL,
        NULL, NULL, NULL, NULL);

-- =====================================================================================================================
-- 验证数据
-- 1. 首先查看trade
SELECT *
FROM TRADE
WHERE BATCH_NO = '250724001234'
UNION ALL
SELECT a.*, NULL AS mng_org_id, NULL AS mng_org_name
FROM (SELECT * FROM TRADE@DB_REMOTE_LINK WHERE BATCH_NO = '250724001234') a;
-- 2. 查看acct_water
SELECT *
FROM ACCT_WATER
WHERE BATCH_NO = '250724001234'
UNION ALL
SELECT *
FROM ACCT_WATER@DB_REMOTE_LINK
WHERE BATCH_NO = '250724001234';
-- 3. 查看real_acct_water
SELECT *
FROM REAL_ACCT_WATER
WHERE BATCH_NO = '250724001234'
UNION ALL
SELECT *
FROM REAL_ACCT_WATER@DB_REMOTE_LINK
WHERE BATCH_NO = '250724001234';
-- 4. 查看e_bill_task
SELECT *
FROM E_BILL_TASK
WHERE BATCH_NO = '250724001234'
UNION ALL
SELECT *
FROM E_BILL_TASK@DB_REMOTE_LINK
WHERE BATCH_NO = '250724001234';
-- 5. 查看base_info
SELECT b.*
FROM BASE_INFO b
WHERE INFO_ID IN (SELECT INFO_ID
                  FROM BASE_INFO_OPER
                  WHERE BATCH_NO IN (SELECT TRADE.BATCH_NO
                                     FROM TRADE
                                     WHERE TRAN_TYPE = '3110'
                                       AND REG_DATE >= '20250501'))
UNION ALL
SELECT a.*, 100 AS mng_org_id
FROM BASE_INFO@DB_REMOTE_LINK a
WHERE INFO_ID IN (SELECT INFO_ID
                  FROM BASE_INFO_OPER@DB_REMOTE_LINK
                  WHERE BATCH_NO IN (SELECT TRADE.BATCH_NO@DB_REMOTE_LINK
                                     FROM TRADE@DB_REMOTE_LINK
                                     WHERE TRAN_TYPE = '3110'
                                       AND REG_DATE >= '20250501'));

-- =====================================================================================================================
-- 其余的5条数据
-- 插入trade数据
INSERT INTO TRADE
SELECT a.*, 100 AS mng_org_id, '天津市住房保障服务中心' AS mng_org_namm
FROM (SELECT *
      FROM TRADE@DB_REMOTE_LINK
      WHERE BATCH_NO IN (SELECT BATCH_NO
                         FROM TRADE@DB_REMOTE_LINK
                         WHERE TRAN_TYPE = '3110'
                           AND REG_DATE >= '20250501'
                           AND BATCH_NO <> '250916001028')) a;

UPDATE TRADE
SET TRAN_STATUS  = '09ZaiTuJiaoYi',
    FINISH_TIME  = NULL,
    FINISH_DATE  = NULL,
    SYS_DATE     = NULL,
    SYS_TIME     = NULL,
    MNG_ORG_ID   = 100,
    MNG_ORG_NAME = '天津市住房保障服务中心'
WHERE BATCH_NO IN (SELECT BATCH_NO
                   FROM TRADE@DB_REMOTE_LINK
                   WHERE TRAN_TYPE = '3110'
                     AND REG_DATE >= '20250501'
                     AND BATCH_NO <> '250916001028');
-- 插入trade_bank表
INSERT INTO TRADE_BANK
SELECT a.*
FROM (SELECT *
      FROM TRADE_BANK@DB_REMOTE_LINK
      WHERE BATCH_NO IN (SELECT BATCH_NO
                         FROM TRADE@DB_REMOTE_LINK
                         WHERE TRAN_TYPE = '3110'
                           AND REG_DATE >= '20250501'
                           AND BATCH_NO <> '250916001028')) a;
-- 插入操作表
INSERT INTO BASE_INFO_OPER
SELECT a.*, 100 AS mng_org_id
FROM (SELECT *
      FROM BASE_INFO_OPER@DB_REMOTE_LINK
      WHERE BATCH_NO IN (SELECT BATCH_NO
                         FROM TRADE@DB_REMOTE_LINK
                         WHERE TRAN_TYPE = '3110'
                           AND REG_DATE >= '20250501'
                           AND BATCH_NO <> '250916001028')) a;
INSERT INTO HOU_INFO_OPER
SELECT a.*
FROM (SELECT *
      FROM HOU_INFO_OPER@DB_REMOTE_LINK
      WHERE BATCH_NO IN (SELECT BATCH_NO
                         FROM TRADE@DB_REMOTE_LINK
                         WHERE TRAN_TYPE = '3110'
                           AND REG_DATE >= '20250501'
                           AND BATCH_NO <> '250916001028')) a;
INSERT INTO HOU_UNITS_OPER
SELECT a.*
FROM (SELECT *
      FROM HOU_UNITS_OPER@DB_REMOTE_LINK
      WHERE BATCH_NO IN (SELECT BATCH_NO
                         FROM TRADE@DB_REMOTE_LINK
                         WHERE TRAN_TYPE = '3110'
                           AND REG_DATE >= '20250501'
                           AND BATCH_NO <> '250916001028')) a;
-- 插入pay_detail
INSERT INTO PAY_DETAIL
SELECT a.*
FROM (SELECT *
      FROM PAY_DETAIL@DB_REMOTE_LINK
      WHERE BATCH_NO IN (SELECT BATCH_NO
                         FROM TRADE@DB_REMOTE_LINK
                         WHERE TRAN_TYPE = '3110'
                           AND REG_DATE >= '20250501'
                           AND BATCH_NO <> '250916001028')) a;
-- 插入pay_sum
INSERT INTO PAY_SUM
SELECT a.*
FROM (SELECT *
      FROM PAY_SUM@DB_REMOTE_LINK
      WHERE BATCH_NO IN (SELECT BATCH_NO
                         FROM TRADE@DB_REMOTE_LINK
                         WHERE TRAN_TYPE = '3110'
                           AND REG_DATE >= '20250501'
                           AND BATCH_NO <> '250916001028')) a;